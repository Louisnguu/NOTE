from flask import Flask, request, jsonify, render_template
import mysql.connector
from flask_cors import CORS
import datetime
import threading
import time
import pygame
import os
import psycopg2
import atexit  # Th√™m v√†o ƒë·∫ßu file

app = Flask(__name__, static_folder="static")
CORS(app)

# L∆∞u ghi ch√∫ ƒë√£ nh·∫Øc nh·ªü
notified_notes = set()

def get_db_connection():
    return mysql.connector.connect(
        host=os.getenv("DB_HOST", "127.0.0.1"),
        user=os.getenv("DB_USER", "root"),
        password=os.getenv("DB_PASS", "usbw"),
        port=os.getenv("DB_PORT", "3307"),
        database=os.getenv("DB_NAME", "luu_tru_ghi_chu")
    )

def stop_reminder_thread():
    global reminder_running
    reminder_running = False

@app.route("/")
def home():
    return render_template("index.html")

@app.route('/delete_note', methods=['POST'])
def delete_note():
    data = request.get_json()
    title = data.get("title")

    if not title:
        return jsonify({"error": "Kh√¥ng c√≥ ti√™u ƒë·ªÅ!"}), 400

    try:
        conn = get_db_connection()
        cursor = conn.cursor()
        sql = "DELETE FROM bang_ghi_chu WHERE Title = %s"
        cursor.execute(sql, (title,))
        conn.commit()
        cursor.close()
        conn.close()
        return jsonify({"message": "Ghi ch√∫ ƒë√£ ƒë∆∞·ª£c x√≥a!"}), 200
    except mysql.connector.Error as err:
        return jsonify({"error": "L·ªói x√≥a ghi ch√∫!", "details": str(err)}), 500

@app.route('/save_note', methods=['POST'])
def save_note():
    if not request.is_json:
        return jsonify({"error": "D·ªØ li·ªáu kh√¥ng h·ª£p l·ªá!"}), 415  
    data = request.get_json()
    
    tit = data['_title']
    bod = data['_body']
    datim = data['date_time']

    try:
        conn = get_db_connection()
        cursor = conn.cursor()
        sql = "INSERT INTO bang_ghi_chu (Title, Body, Remind_Time) VALUES (%s, %s, %s)"
        cursor.execute(sql, (tit, bod, datim))
        conn.commit()
        cursor.close()
        conn.close()
        return jsonify({"message": "Ghi ch√∫ ƒë√£ ƒë∆∞·ª£c l∆∞u!"}), 200
    except mysql.connector.Error as err:
        return jsonify({"error": "Kh√¥ng th·ªÉ l∆∞u ghi ch√∫!", "details": str(err)}), 500

# H√†m ki·ªÉm tra v√† nh·∫Øc nh·ªü ghi ch√∫
reminder_running = False  # Th√™m bi·∫øn ki·ªÉm so√°t
atexit.register(stop_reminder_thread)
def remind():
    global notified_notes, reminder_running
    if reminder_running:
        return
    reminder_running = True
    while reminder_running:  # ƒê·∫£m b·∫£o thread s·∫Ω d·ª´ng khi `reminder_running` = False
        try:
            conn = get_db_connection()
            cursor = conn.cursor()
            
            now = datetime.datetime.now().strftime('%m-%d %H:%M')
            query = "SELECT Title, Body FROM bang_ghi_chu WHERE DATE_FORMAT(Remind_Time, '%m-%d %H:%i') = %s"
            cursor.execute(query, (now,))
            notes = cursor.fetchall()

            for title, content in notes:
                note_key = f"{title}-{now}"
                if note_key not in notified_notes:
                    notified_notes.add(note_key)
                    print(f"üîî Nh·∫Øc nh·ªü: {title} - {content}")
                    show_popup(title, content)

            cursor.close()
            conn.close()
        except mysql.connector.Error as err:
            print("L·ªói MySQL:", err)

        time.sleep(60)  # Thay v√¨ 1 gi√¢y, b·∫°n c√≥ th·ªÉ tƒÉng l√™n 60 gi√¢y ƒë·ªÉ gi·∫£m t·∫£i c∆° s·ªü d·ªØ li·ªáu

# H√†m hi·ªÉn th·ªã popup trong tr√¨nh duy·ªát
def show_popup(title, content):
    # Tr·∫£ v·ªÅ d·ªØ li·ªáu th√¥ng qua Flask ƒë·ªÉ render ra HTML v√† s·ª≠ d·ª•ng JavaScript hi·ªÉn th·ªã popup
    app.jinja_env.globals.update(title=title, content=content)
    return render_template('popup.html', title=title, content=content)

if __name__ == '__main__':
    if not reminder_running:
        reminder_thread = threading.Thread(target=remind, daemon=True)
        reminder_thread.start()

    app.run(host="127.0.0.1", port=5000, debug=True, use_reloader=False)
